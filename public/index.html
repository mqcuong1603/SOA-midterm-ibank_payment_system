<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iBanking - Tuition Payment System</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --success-color: #27ae60;
        --danger-color: #e74c3c;
        --light-bg: #ecf0f1;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .container-main {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .auth-card,
      .payment-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      .auth-card {
        max-width: 400px;
        width: 100%;
      }

      .payment-card {
        max-width: 900px;
        width: 100%;
      }

      .card-header-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .card-header-custom h3 {
        margin: 0;
        font-weight: 600;
        font-size: 24px;
      }

      .card-header-custom .subtitle {
        margin-top: 10px;
        opacity: 0.9;
        font-size: 14px;
      }

      .form-control,
      .form-select {
        border-radius: 10px;
        border: 1px solid #ddd;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .form-control:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
      }

      .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s;
        color: white;
      }

      .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        color: white;
      }

      .btn-primary-custom:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .section-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
      }

      .section-title {
        color: #495057;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }

      .section-title i {
        margin-right: 10px;
        color: #667eea;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: #6c757d;
        font-size: 14px;
      }

      .info-value {
        color: #212529;
        font-weight: 600;
        font-size: 14px;
      }

      .balance-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .balance-label {
        font-size: 14px;
        opacity: 0.9;
      }

      .balance-amount {
        font-size: 28px;
        font-weight: bold;
        margin-top: 5px;
      }

      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 20px;
      }

      .step {
        flex: 1;
        text-align: center;
        position: relative;
      }

      .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .step.active .step-circle {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .step.completed .step-circle {
        background: #27ae60;
        color: white;
      }

      .step-label {
        font-size: 12px;
        color: #6c757d;
      }

      .step.active .step-label {
        color: #667eea;
        font-weight: 600;
      }

      .otp-input-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }

      .otp-input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #ddd;
        border-radius: 10px;
        transition: all 0.3s;
      }

      .otp-input:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-right: 8px;
      }

      .alert {
        border-radius: 10px;
        border: none;
      }

      .navbar-custom {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .receipt-modal .modal-content {
        border-radius: 20px;
        overflow: hidden;
      }

      .receipt-header {
        background: linear-gradient(135deg, #27ae60 0%, #16a085 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .receipt-body {
        padding: 30px;
      }

      .success-icon {
        font-size: 60px;
        margin-bottom: 20px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      .terms-checkbox {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .countdown-timer {
        color: #e74c3c;
        font-weight: bold;
        font-size: 18px;
      }

      @media (max-width: 768px) {
        .payment-card {
          margin: 20px 10px;
        }

        .step-indicator {
          padding: 0 10px;
        }

        .step-label {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Page -->
    <div id="loginPage" class="container-main">
      <div class="auth-card fade-in">
        <div class="card-header-custom">
          <i class="bi bi-bank2" style="font-size: 48px"></i>
          <h3 class="mt-3">iBanking System</h3>
          <div class="subtitle">Tuition Payment Portal</div>
        </div>
        <div class="card-body p-4">
          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="bi bi-person"></i
                ></span>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  required
                />
              </div>
            </div>
            <div class="mb-4">
              <label for="password" class="form-label">Password</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  required
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="togglePassword"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>
            <button
              type="submit"
              class="btn btn-primary-custom w-100"
              id="loginBtn"
            >
              Sign In
            </button>
          </form>
          <div
            id="loginAlert"
            class="alert alert-danger mt-3 d-none"
            role="alert"
          ></div>
        </div>
      </div>
    </div>

    <!-- Payment Page -->
    <div id="paymentPage" class="d-none">
      <!-- Navbar -->
      <nav class="navbar navbar-custom fixed-top">
        <div class="container">
          <div class="navbar-brand">
            <i class="bi bi-bank2" style="font-size: 24px; color: #667eea"></i>
            <span class="ms-2 fw-bold">iBanking</span>
          </div>
          <div class="user-info">
            <div class="text-end">
              <div class="fw-bold" id="navUserName">John Doe</div>
              <div class="text-muted small" id="navUserEmail">
                john@email.com
              </div>
            </div>
            <div class="user-avatar" id="userAvatar">JD</div>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <div class="container" style="margin-top: 100px; margin-bottom: 50px">
        <div class="payment-card fade-in">
          <div class="card-header-custom">
            <h3>Tuition Payment</h3>
            <div class="subtitle">Academic Year 2024-2025</div>
          </div>

          <div class="card-body p-4">
            <!-- Step Indicator -->
            <div class="step-indicator">
              <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">Student Info</div>
              </div>
              <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">Verify OTP</div>
              </div>
              <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">Confirm</div>
              </div>
              <div class="step" id="step4">
                <div class="step-circle">4</div>
                <div class="step-label">Complete</div>
              </div>
            </div>

            <!-- Payment Form -->
            <form id="paymentForm">
              <!-- Payer Information -->
              <div class="section-card">
                <div class="section-title">
                  <i class="bi bi-person-circle"></i>
                  Payer Information
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Full Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="payerName"
                      disabled
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Phone Number</label>
                    <input
                      type="text"
                      class="form-control"
                      id="payerPhone"
                      disabled
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Email Address</label>
                    <input
                      type="email"
                      class="form-control"
                      id="payerEmail"
                      disabled
                    />
                  </div>
                </div>
              </div>

              <!-- Balance Information -->
              <div class="balance-card">
                <div class="row align-items-center">
                  <div class="col">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount" id="availableBalance">₫0</div>
                  </div>
                  <div class="col-auto">
                    <i
                      class="bi bi-wallet2"
                      style="font-size: 48px; opacity: 0.5"
                    ></i>
                  </div>
                </div>
              </div>

              <!-- Student Information -->
              <div class="section-card">
                <div class="section-title">
                  <i class="bi bi-mortarboard"></i>
                  Student Information
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Student ID</label>
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        id="studentId"
                        placeholder="Enter student ID"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        id="searchStudentBtn"
                      >
                        <i class="bi bi-search"></i> Search
                      </button>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Student Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="studentName"
                      disabled
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Tuition Amount</label>
                    <input
                      type="text"
                      class="form-control"
                      id="tuitionAmount"
                      disabled
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Academic Year</label>
                    <input
                      type="text"
                      class="form-control"
                      id="academicYear"
                      disabled
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Semester</label>
                    <input
                      type="text"
                      class="form-control"
                      id="semester"
                      disabled
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Due Date</label>
                    <input
                      type="text"
                      class="form-control"
                      id="dueDate"
                      disabled
                    />
                  </div>
                </div>
              </div>

              <!-- Payment Summary -->
              <div class="section-card d-none" id="paymentSummary">
                <div class="section-title">
                  <i class="bi bi-credit-card"></i>
                  Payment Summary
                </div>
                <div class="info-row">
                  <span class="info-label">Transaction Code</span>
                  <span class="info-value" id="transactionCode">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Payment Amount</span>
                  <span class="info-value" id="paymentAmount">₫0</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Remaining Balance</span>
                  <span class="info-value" id="remainingBalance">₫0</span>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="terms-checkbox">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="termsCheckbox"
                  />
                  <label class="form-check-label" for="termsCheckbox">
                    I agree to the
                    <a
                      href="#"
                      data-bs-toggle="modal"
                      data-bs-target="#termsModal"
                      >Terms and Conditions</a
                    >
                    for this transaction
                  </label>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="text-center mt-4">
                <button
                  type="button"
                  class="btn btn-primary-custom px-5"
                  id="initiatePaymentBtn"
                  disabled
                >
                  <i class="bi bi-arrow-right-circle"></i> Proceed to Payment
                </button>
              </div>
            </form>

            <!-- OTP Verification Section -->
            <div id="otpSection" class="d-none">
              <div class="section-card">
                <div class="section-title">
                  <i class="bi bi-shield-check"></i>
                  OTP Verification
                </div>
                <div class="text-center">
                  <p class="mb-3">Enter the 6-digit OTP sent to your email</p>
                  <div class="otp-input-group">
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp1"
                    />
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp2"
                    />
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp3"
                    />
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp4"
                    />
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp5"
                    />
                    <input
                      type="text"
                      class="otp-input"
                      maxlength="1"
                      id="otp6"
                    />
                  </div>
                  <div class="mt-3">
                    <div class="countdown-timer" id="otpTimer">
                      Time remaining: 5:00
                    </div>
                  </div>
                  <div class="mt-4">
                    <button
                      type="button"
                      class="btn btn-outline-secondary me-2"
                      id="resendOtpBtn"
                    >
                      <i class="bi bi-arrow-clockwise"></i> Resend OTP
                    </button>
                    <button
                      type="button"
                      class="btn btn-primary-custom"
                      id="verifyOtpBtn"
                    >
                      <i class="bi bi-check-circle"></i> Verify OTP
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Final Confirmation Section -->
            <div id="confirmSection" class="d-none">
              <div class="section-card">
                <div class="section-title">
                  <i class="bi bi-check2-circle"></i>
                  Final Confirmation
                </div>
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  Please review the payment details carefully before confirming.
                </div>
                <div class="info-row">
                  <span class="info-label">Student ID</span>
                  <span class="info-value" id="confirmStudentId">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Student Name</span>
                  <span class="info-value" id="confirmStudentName">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Amount to Pay</span>
                  <span
                    class="info-value text-danger fw-bold"
                    id="confirmAmount"
                    >₫0</span
                  >
                </div>
                <div class="text-center mt-4">
                  <button
                    type="button"
                    class="btn btn-outline-secondary me-2"
                    onclick="cancelPayment()"
                  >
                    <i class="bi bi-x-circle"></i> Cancel
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary-custom px-5"
                    id="confirmPaymentBtn"
                  >
                    <i class="bi bi-check-circle"></i> Confirm Payment
                  </button>
                </div>
              </div>
            </div>

            <!-- Alerts -->
            <div id="alertContainer" class="mt-3"></div>
          </div>
        </div>

        <!-- Transaction History -->
        <div class="payment-card mt-4">
          <div class="card-body">
            <h5 class="mb-3">
              <i class="bi bi-clock-history"></i> Recent Transactions
            </h5>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Transaction Code</th>
                    <th>Student ID</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="transactionHistory">
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      No transactions found
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content receipt-modal">
          <div class="receipt-header">
            <i class="bi bi-check-circle success-icon"></i>
            <h4>Payment Successful!</h4>
          </div>
          <div class="receipt-body">
            <h5 class="mb-3">Transaction Receipt</h5>
            <div class="info-row">
              <span class="info-label">Transaction Code</span>
              <span class="info-value" id="receiptTransactionCode">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Student ID</span>
              <span class="info-value" id="receiptStudentId">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Amount Paid</span>
              <span class="info-value text-success fw-bold" id="receiptAmount"
                >₫0</span
              >
            </div>
            <div class="info-row">
              <span class="info-label">Date & Time</span>
              <span class="info-value" id="receiptDateTime">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">New Balance</span>
              <span class="info-value" id="receiptNewBalance">₫0</span>
            </div>
            <div class="text-center mt-4">
              <button
                type="button"
                class="btn btn-primary-custom"
                onclick="resetPaymentForm()"
              >
                <i class="bi bi-arrow-repeat"></i> Make Another Payment
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Terms and Conditions</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <h6>1. Payment Authorization</h6>
            <p>
              By proceeding with this payment, you authorize iBanking to deduct
              the specified tuition amount from your account.
            </p>

            <h6>2. Non-Refundable</h6>
            <p>
              All tuition payments are final and non-refundable once processed.
            </p>

            <h6>3. Verification</h6>
            <p>
              You confirm that all information provided is accurate and that you
              have the authority to make this payment.
            </p>

            <h6>4. Security</h6>
            <p>
              All transactions are secured with OTP verification sent to your
              registered email address.
            </p>

            <h6>5. Transaction Limits</h6>
            <p>
              Payments can only be made for the full tuition amount. Partial
              payments are not accepted.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Configuration
      const API_URL = "http://localhost:3000/api";
      let authToken = null;
      let currentUser = null;
      let currentTransaction = null;
      let otpTimer = null;
      let otpCountdown = 300; // 5 minutes in seconds

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Check if already logged in
        const token = localStorage.getItem("authToken");
        if (token) {
          authToken = token;
          loadUserProfile();
        }

        // Setup event listeners
        setupEventListeners();
      });

      function setupEventListeners() {
        // Login form
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);

        // Toggle password visibility
        document
          .getElementById("togglePassword")
          .addEventListener("click", function () {
            const passwordInput = document.getElementById("password");
            const icon = this.querySelector("i");
            if (passwordInput.type === "password") {
              passwordInput.type = "text";
              icon.classList.replace("bi-eye", "bi-eye-slash");
            } else {
              passwordInput.type = "password";
              icon.classList.replace("bi-eye-slash", "bi-eye");
            }
          });

        // Search student
        document
          .getElementById("searchStudentBtn")
          .addEventListener("click", searchStudent);
        document
          .getElementById("studentId")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              searchStudent();
            }
          });

        // Terms checkbox
        document
          .getElementById("termsCheckbox")
          .addEventListener("change", function () {
            checkPaymentReadiness();
          });

        // Payment buttons
        document
          .getElementById("initiatePaymentBtn")
          .addEventListener("click", initiatePayment);
        document
          .getElementById("verifyOtpBtn")
          .addEventListener("click", verifyOTP);
        document
          .getElementById("resendOtpBtn")
          .addEventListener("click", resendOTP);
        document
          .getElementById("confirmPaymentBtn")
          .addEventListener("click", confirmPayment);

        // OTP inputs
        setupOTPInputs();
      }

      function setupOTPInputs() {
        const otpInputs = document.querySelectorAll(".otp-input");
        otpInputs.forEach((input, index) => {
          input.addEventListener("input", function () {
            if (this.value.length === 1 && index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }
          });

          input.addEventListener("keydown", function (e) {
            if (e.key === "Backspace" && this.value === "" && index > 0) {
              otpInputs[index - 1].focus();
            }
          });

          input.addEventListener("paste", function (e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData("text").slice(0, 6);
            for (
              let i = 0;
              i < pastedData.length && i < otpInputs.length;
              i++
            ) {
              otpInputs[i].value = pastedData[i];
            }
          });
        });
      }

      // Authentication functions
      async function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const loginBtn = document.getElementById("loginBtn");
        const loginAlert = document.getElementById("loginAlert");

        try {
          loginBtn.disabled = true;
          loginBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';

          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem("authToken", authToken);
            showPaymentPage();
          } else {
            showAlert("loginAlert", data.error || "Login failed", "danger");
          }
        } catch (error) {
          showAlert(
            "loginAlert",
            "Connection error. Please try again.",
            "danger"
          );
        } finally {
          loginBtn.disabled = false;
          loginBtn.innerHTML = "Sign In";
        }
      }

      async function loadUserProfile() {
        try {
          const response = await fetch(`${API_URL}/user/profile`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            currentUser = data;
            showPaymentPage();
          } else {
            logout();
          }
        } catch (error) {
          console.error("Profile load error:", error);
          logout();
        }
      }

      function showPaymentPage() {
        document.getElementById("loginPage").classList.add("d-none");
        document.getElementById("paymentPage").classList.remove("d-none");

        // Update user information
        document.getElementById("navUserName").textContent =
          currentUser.fullName;
        document.getElementById("navUserEmail").textContent = currentUser.email;
        document.getElementById("userAvatar").textContent = currentUser.fullName
          .split(" ")
          .map((n) => n[0])
          .join("");

        // Fill payer information
        document.getElementById("payerName").value = currentUser.fullName;
        document.getElementById("payerPhone").value = currentUser.phone;
        document.getElementById("payerEmail").value = currentUser.email;
        document.getElementById("availableBalance").textContent =
          formatCurrency(currentUser.balance);

        // Load transaction history
        loadTransactionHistory();
      }

      function logout() {
        localStorage.removeItem("authToken");
        authToken = null;
        currentUser = null;
        location.reload();
      }

      // Student search
      async function searchStudent() {
        const studentId = document.getElementById("studentId").value.trim();
        if (!studentId) {
          showAlert("alertContainer", "Please enter a student ID", "warning");
          return;
        }

        const searchBtn = document.getElementById("searchStudentBtn");
        try {
          searchBtn.disabled = true;
          searchBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span>';

          const response = await fetch(`${API_URL}/student/${studentId}`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          const data = await response.json();

          if (response.ok) {
            if (data.isPaid) {
              showAlert(
                "alertContainer",
                "Tuition for this student has already been paid",
                "info"
              );
              clearStudentInfo();
            } else {
              fillStudentInfo(data);
              checkPaymentReadiness();
            }
          } else {
            showAlert(
              "alertContainer",
              data.error || "Student not found",
              "danger"
            );
            clearStudentInfo();
          }
        } catch (error) {
          showAlert("alertContainer", "Error searching for student", "danger");
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = '<i class="bi bi-search"></i> Search';
        }
      }

      function fillStudentInfo(data) {
        document.getElementById("studentName").value = data.studentName;
        document.getElementById("tuitionAmount").value = formatCurrency(
          data.tuitionAmount
        );
        document.getElementById("academicYear").value = data.academicYear;
        document.getElementById("semester").value = `Semester ${data.semester}`;
        document.getElementById("dueDate").value = new Date(
          data.dueDate
        ).toLocaleDateString();

        // Store tuition amount for later use
        document.getElementById("tuitionAmount").dataset.amount =
          data.tuitionAmount;
      }

      function clearStudentInfo() {
        document.getElementById("studentName").value = "";
        document.getElementById("tuitionAmount").value = "";
        document.getElementById("academicYear").value = "";
        document.getElementById("semester").value = "";
        document.getElementById("dueDate").value = "";
        document.getElementById("termsCheckbox").checked = false;
        checkPaymentReadiness();
      }

      function checkPaymentReadiness() {
        const studentName = document.getElementById("studentName").value;
        const termsAccepted = document.getElementById("termsCheckbox").checked;
        const tuitionAmount = parseFloat(
          document.getElementById("tuitionAmount").dataset.amount || 0
        );
        const balance = currentUser ? currentUser.balance : 0;

        const canProceed =
          studentName &&
          termsAccepted &&
          tuitionAmount > 0 &&
          balance >= tuitionAmount;
        document.getElementById("initiatePaymentBtn").disabled = !canProceed;

        if (tuitionAmount > balance && tuitionAmount > 0) {
          showAlert(
            "alertContainer",
            "Insufficient balance for this payment",
            "warning"
          );
        }
      }

      // Payment process
      async function initiatePayment() {
        const studentId = document.getElementById("studentId").value;
        const amount = parseFloat(
          document.getElementById("tuitionAmount").dataset.amount
        );

        const btn = document.getElementById("initiatePaymentBtn");
        try {
          btn.disabled = true;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

          const response = await fetch(`${API_URL}/payment/initiate`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ studentId, amount }),
          });

          const data = await response.json();

          if (response.ok) {
            currentTransaction = data;
            document.getElementById("transactionCode").textContent =
              data.transactionCode;
            document.getElementById("paymentAmount").textContent =
              formatCurrency(data.amount);
            document.getElementById("remainingBalance").textContent =
              formatCurrency(currentUser.balance - data.amount);
            document
              .getElementById("paymentSummary")
              .classList.remove("d-none");

            // Send OTP
            await sendOTP();
          } else {
            showAlert(
              "alertContainer",
              data.error || "Payment initiation failed",
              "danger"
            );
          }
        } catch (error) {
          showAlert("alertContainer", "Error initiating payment", "danger");
        } finally {
          btn.disabled = false;
          btn.innerHTML =
            '<i class="bi bi-arrow-right-circle"></i> Proceed to Payment';
        }
      }

      async function sendOTP() {
        try {
          const response = await fetch(`${API_URL}/payment/send-otp`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transactionId: currentTransaction.transactionId,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showOTPSection();
            startOTPTimer();
            showAlert(
              "alertContainer",
              "OTP has been sent to your email",
              "success"
            );
          } else {
            showAlert(
              "alertContainer",
              data.error || "Failed to send OTP",
              "danger"
            );
          }
        } catch (error) {
          showAlert("alertContainer", "Error sending OTP", "danger");
        }
      }

      async function resendOTP() {
        const btn = document.getElementById("resendOtpBtn");
        btn.disabled = true;
        await sendOTP();
        setTimeout(() => {
          btn.disabled = false;
        }, 30000); // Disable resend for 30 seconds
      }

      function showOTPSection() {
        document.getElementById("paymentForm").classList.add("d-none");
        document.getElementById("otpSection").classList.remove("d-none");
        updateStepIndicator(2);

        // Clear OTP inputs
        document
          .querySelectorAll(".otp-input")
          .forEach((input) => (input.value = ""));
        document.getElementById("otp1").focus();
      }

      function startOTPTimer() {
        otpCountdown = 300;
        clearInterval(otpTimer);

        otpTimer = setInterval(() => {
          otpCountdown--;
          const minutes = Math.floor(otpCountdown / 60);
          const seconds = otpCountdown % 60;
          document.getElementById(
            "otpTimer"
          ).textContent = `Time remaining: ${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;

          if (otpCountdown <= 0) {
            clearInterval(otpTimer);
            document.getElementById("otpTimer").textContent = "OTP expired";
            document.getElementById("verifyOtpBtn").disabled = true;
          }
        }, 1000);
      }

      async function verifyOTP() {
        const otp = Array.from(document.querySelectorAll(".otp-input"))
          .map((input) => input.value)
          .join("");

        if (otp.length !== 6) {
          showAlert("alertContainer", "Please enter complete OTP", "warning");
          return;
        }

        const btn = document.getElementById("verifyOtpBtn");
        try {
          btn.disabled = true;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';

          const response = await fetch(`${API_URL}/payment/verify-otp`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transactionId: currentTransaction.transactionId,
              otpCode: otp,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            clearInterval(otpTimer);
            showConfirmationSection();
          } else {
            showAlert("alertContainer", data.error || "Invalid OTP", "danger");
            document
              .querySelectorAll(".otp-input")
              .forEach((input) => (input.value = ""));
            document.getElementById("otp1").focus();
          }
        } catch (error) {
          showAlert("alertContainer", "Error verifying OTP", "danger");
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Verify OTP';
        }
      }

      function showConfirmationSection() {
        document.getElementById("otpSection").classList.add("d-none");
        document.getElementById("confirmSection").classList.remove("d-none");
        updateStepIndicator(3);

        // Fill confirmation details
        document.getElementById("confirmStudentId").textContent =
          document.getElementById("studentId").value;
        document.getElementById("confirmStudentName").textContent =
          document.getElementById("studentName").value;
        document.getElementById("confirmAmount").textContent =
          document.getElementById("tuitionAmount").value;
      }

      async function confirmPayment() {
        const btn = document.getElementById("confirmPaymentBtn");
        try {
          btn.disabled = true;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Processing payment...';

          const response = await fetch(`${API_URL}/payment/confirm`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transactionId: currentTransaction.transactionId,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            updateStepIndicator(4);
            showSuccessModal(data);
            currentUser.balance = data.newBalance;
            document.getElementById("availableBalance").textContent =
              formatCurrency(data.newBalance);
            loadTransactionHistory();
          } else {
            showAlert(
              "alertContainer",
              data.error || "Payment failed",
              "danger"
            );
          }
        } catch (error) {
          showAlert("alertContainer", "Error processing payment", "danger");
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Payment';
        }
      }

      function showSuccessModal(data) {
        document.getElementById("receiptTransactionCode").textContent =
          data.receipt.transactionCode;
        document.getElementById("receiptStudentId").textContent =
          data.receipt.studentId;
        document.getElementById("receiptAmount").textContent = formatCurrency(
          data.receipt.amount
        );
        document.getElementById("receiptDateTime").textContent = new Date(
          data.receipt.completedAt
        ).toLocaleString();
        document.getElementById("receiptNewBalance").textContent =
          formatCurrency(data.newBalance);

        const modal = new bootstrap.Modal(
          document.getElementById("successModal")
        );
        modal.show();
      }

      async function loadTransactionHistory() {
        try {
          const response = await fetch(
            `${API_URL}/transactions/history?limit=5`,
            {
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            displayTransactionHistory(data.transactions);
          }
        } catch (error) {
          console.error("Error loading transaction history:", error);
        }
      }

      function displayTransactionHistory(transactions) {
        const tbody = document.getElementById("transactionHistory");

        if (transactions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">No transactions found</td></tr>';
          return;
        }

        tbody.innerHTML = transactions
          .map(
            (tx) => `
                <tr>
                    <td><small>${tx.transactionCode}</small></td>
                    <td>${tx.studentId}</td>
                    <td>${formatCurrency(tx.amount)}</td>
                    <td>${getStatusBadge(tx.status)}</td>
                    <td>${new Date(tx.createdAt).toLocaleDateString()}</td>
                </tr>
            `
          )
          .join("");
      }

      function getStatusBadge(status) {
        const badges = {
          completed: '<span class="badge bg-success">Completed</span>',
          pending: '<span class="badge bg-warning">Pending</span>',
          failed: '<span class="badge bg-danger">Failed</span>',
          otp_sent: '<span class="badge bg-info">OTP Sent</span>',
          otp_verified: '<span class="badge bg-primary">Verified</span>',
        };
        return badges[status] || status;
      }

      // Helper functions
      function updateStepIndicator(step) {
        for (let i = 1; i <= 4; i++) {
          const stepEl = document.getElementById(`step${i}`);
          stepEl.classList.remove("active", "completed");

          if (i < step) {
            stepEl.classList.add("completed");
          } else if (i === step) {
            stepEl.classList.add("active");
          }
        }
      }

      function resetPaymentForm() {
        // Hide modal
        bootstrap.Modal.getInstance(
          document.getElementById("successModal")
        ).hide();

        // Reset form
        document.getElementById("studentId").value = "";
        clearStudentInfo();
        document.getElementById("paymentSummary").classList.add("d-none");
        document.getElementById("confirmSection").classList.add("d-none");
        document.getElementById("otpSection").classList.add("d-none");
        document.getElementById("paymentForm").classList.remove("d-none");

        // Reset step indicator
        updateStepIndicator(1);

        // Clear transaction
        currentTransaction = null;
        clearInterval(otpTimer);
      }

      function cancelPayment() {
        if (confirm("Are you sure you want to cancel this payment?")) {
          resetPaymentForm();
          showAlert("alertContainer", "Payment cancelled", "info");
        }
      }

      function showAlert(containerId, message, type) {
        const container = document.getElementById(containerId);
        const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        container.innerHTML = alertHtml;

        // Auto dismiss after 5 seconds
        setTimeout(() => {
          const alert = container.querySelector(".alert");
          if (alert) {
            bootstrap.Alert.getOrCreateInstance(alert).close();
          }
        }, 5000);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }
    </script>
  </body>
</html>
